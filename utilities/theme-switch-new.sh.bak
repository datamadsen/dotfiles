#!/usr/bin/env zsh

# New omarchy-inspired theme switcher
# Usage: theme-switch-new.sh [theme-name|list]

THEMES_DIR="$HOME/dotfiles/themes"
CURRENT_LINK="$THEMES_DIR/current"

# Function to list available themes
list_themes() {
    echo "Available themes:"
    for theme_dir in "$THEMES_DIR"/*/; do
        if [ -d "$theme_dir" ]; then
            theme_name=$(basename "$theme_dir")
            if [ "$theme_name" != "current" ]; then
                if [ "$(readlink "$CURRENT_LINK")" = "$theme_name" ]; then
                    echo "  * $theme_name (current)"
                else
                    echo "    $theme_name"
                fi
            fi
        fi
    done
}

# Function to switch theme
switch_theme() {
    local theme_name="$1"
    local theme_path="$THEMES_DIR/$theme_name"
    
    if [ ! -d "$theme_path" ]; then
        echo "Error: Theme '$theme_name' not found"
        echo ""
        list_themes
        exit 1
    fi
    
    # Update symlink with absolute path
    rm -f "$CURRENT_LINK"
    ln -sf "$theme_path" "$CURRENT_LINK"
    
    # Touch the main alacritty config to trigger reload
    touch "$HOME/.config/alacritty/alacritty.toml" 2>/dev/null || touch "$HOME/dotfiles/alacritty/alacritty.toml"
    
    # Update bat config by copying theme-specific config and appending base config
    if [ -f "$theme_path/bat.conf" ]; then
        local bat_config="$HOME/.config/bat/config"
        local base_bat_config="$HOME/dotfiles/bat/config"
        local temp_config="/tmp/bat_config_$$"
        
        # Create new config from theme-specific config
        cp "$theme_path/bat.conf" "$temp_config"
        echo "" >> "$temp_config"  # Add newline
        
        # Append base configuration (excluding theme line)
        grep -v "^--theme=" "$base_bat_config" >> "$temp_config"
        
        # Move to final location
        mv "$temp_config" "$bat_config"
    fi
    
    # Update btop theme with symlink
    if [ -f "$theme_path/btop.theme" ]; then
        mkdir -p "$HOME/.config/btop/themes"
        ln -sf "$theme_path/btop.theme" "$HOME/.config/btop/themes/current.theme"
    fi
    
    # Update fzf-tab theme in current shell
    if [ -f "$theme_path/fzf-tab.zsh" ]; then
        echo "  - fzf-tab: Sourcing theme config..."
        source "$theme_path/fzf-tab.zsh"
        echo "  - fzf-tab: Theme config sourced"
    else
        echo "  - fzf-tab: Theme file not found: $theme_path/fzf-tab.zsh"
    fi
    
    # Show current theme
    echo ""
    echo "Current theme: $(readlink "$THEMES_DIR/current")"
}

# Main logic
case "${1:-}" in
    "list"|"ls")
        list_themes
        ;;
    "")
        echo "Usage: $0 [theme-name|list]"
        echo ""
        list_themes
        ;;
    *)
        switch_theme "$1"
        ;;
esac